/* 
 * WinJS Contrib v2.0.1.0
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

!function(){var e=Windows.UI.ViewManagement,i="WinJSContribViewHelper_",n={queryProxyReadyForRelease:i+"queryProxyReadyForRelease",proxyReadyForRelease:i+"proxyReadyForRelease",proxyReleased:i+"proxyReleased",initialize:i+"initialize",navigateTo:i+"navigateTo"};WinJS.Namespace.define("WinJSContrib.WinRT.MultipleViews",{thisDomain:document.location.protocol+"//"+document.location.host,ViewManager:WinJS.Class.mix(WinJS.Class.define(function(i){this._viewReleasedWrapper=this._viewReleased.bind(this),this.pagewrapper=i,window.addEventListener("message",this._handleMessage.bind(this),!1),e.ApplicationView.getForCurrentView().addEventListener("consolidated",this._handleConsolidated.bind(this),!1)},{_handleMessage:function(e){if(e.origin===WinJSContrib.WinRT.MultipleViews.thisDomain&&e.data.type){var i=this.findViewIndexByViewId(e.data.viewId);null!==i&&this.secondaryViews.getItem(i).data._handleMessage(e),this.dispatchEvent(e.data.type,e.data)}},broadcast:function(e,i){for(var n=0,t=this.secondaryViews.length;t>n;n++){var s=this.secondaryViews.getItem(n).data;s.send(e,i)}},_handleConsolidated:function(){this.closeAll()},_viewReleased:function(e){e.target.removeEventListener("released",this._viewReleasedWrapper,!1);var i=this.findViewIndexByViewId(e.target.viewId);null!==i&&this.secondaryViews.splice(i,1)},secondaryViews:new WinJS.Binding.List([]),closeAll:function(){for(var e=0,i=this.secondaryViews.length;i>e;e++){var n=this.secondaryViews.getItem(e).data;n.close()}},findViewIndexByViewId:function(e){for(var i=0,n=this.secondaryViews.length;n>i;i++){var t=this.secondaryViews.getItem(i).data;if(e===t.viewId)return i}return null},findViewByViewId:function(e){for(var i=0,n=this.secondaryViews.length;n>i;i++){var t=this.secondaryViews.getItem(i).data;if(e===t.viewId)return t}return null},findViewByTitle:function(e){for(var i=0,n=this.secondaryViews.length;n>i;i++){var t=this.secondaryViews.getItem(i).data;if(e===t.title)return t}return null},openViewFor:function(e,i,n,t,s){var a=this.findViewByTitle(e);if(!a)return this.openView(i,n,t,s).then(function(i){i.view.title=e});a.navigateTo(i,n,!0);var o=t||Windows.UI.ViewManagement.ViewSizePreference["default"],r=s||Windows.UI.ViewManagement.ViewSizePreference["default"];return a.startViewInUse(),new WinJS.Promise(function(e,i){Windows.UI.ViewManagement.ApplicationViewSwitcher.tryShowAsStandaloneAsync(a.viewId,r,Windows.UI.ViewManagement.ApplicationView.getForCurrentView().id,o).done(function(i){a.stopViewInUse(),e({view:a,pointer:i})},i)})},openView:function(e,i,n,t){var s=this.createNewView(e,i),a=n||Windows.UI.ViewManagement.ViewSizePreference["default"],o=t||Windows.UI.ViewManagement.ViewSizePreference["default"];return s.startViewInUse(),new WinJS.Promise(function(e,i){Windows.UI.ViewManagement.ApplicationViewSwitcher.tryShowAsStandaloneAsync(s.viewId,o,Windows.UI.ViewManagement.ApplicationView.getForCurrentView().id,a).done(function(i){s.stopViewInUse(),e({view:s,pointer:i})},i)})},projectViewFor:function(e,i,n){if(!Windows.UI.ViewManagement.ProjectionManager.projectionDisplayAvailable)return this.openViewFor(e,i,n);var t=this.findViewByTitle(e);return t?(t.navigateTo(i,n,!0),t.startViewInUse(),new WinJS.Promise(function(e,i){Windows.UI.ViewManagement.ProjectionManager.startProjectingAsync(t.viewId,Windows.UI.ViewManagement.ApplicationView.getForCurrentView().id).done(function(i){t.stopViewInUse(),e({view:t,pointer:i})},i)})):this.projectView(i,n).then(function(i){i.view.title=e})},projectView:function(e,i){if(!Windows.UI.ViewManagement.ProjectionManager.projectionDisplayAvailable)return this.openView(e,i);var n=this.createNewView(e,i);return n.startViewInUse(),new WinJS.Promise(function(e,i){Windows.UI.ViewManagement.ProjectionManager.startProjectingAsync(n.viewId,Windows.UI.ViewManagement.ApplicationView.getForCurrentView().id).done(function(i){n.stopViewInUse(),e({view:n,pointer:i})},i)})},createNewView:function(e,i){var t=null;if(i&&(t=JSON.parse(JSON.stringify(i))),!e)throw"Must specify a URL of a page from your app to show in the new view";var s=MSApp.createNewView(this.pagewrapper);s.postMessage({type:n.initialize,initData:{location:{uri:e,state:t}}},WinJSContrib.WinRT.MultipleViews.thisDomain);var a=new WinJSContrib.WinRT.MultipleViews.ViewLifetimeControlProxy(s);return a.addEventListener("released",this._viewReleasedWrapper,!1),this.secondaryViews.push(a),a}}),WinJS.Utilities.eventMixin,WinJS.Binding.observableMixin),ViewLifetimeControlProxy:WinJS.Class.mix(WinJS.Class.define(function(e){this.appView=e,this.viewId=e.viewId,this.title=""},{_refCount:0,send:function(e,i){if(!e)throw"Must specify a type of message to send to the proxy";i=i||{},i.type=e,this.appView.postMessage(i,WinJSContrib.WinRT.MultipleViews.thisDomain)},navigateTo:function(e,i,n){var t=JSON.parse(JSON.stringify(i));n&&(t.clearNavigationHistory=!0),this.send("navigateTo",{location:{uri:e,state:t}})},_handleMessage:function(e){var i=e.data;switch(i.type){case n.queryProxyReadyForRelease:0===this._refCount&&(this.dispatchEvent("released"),this.send(n.proxyReleased));break;default:this.dispatchEvent(i.type,i)}},appView:null,startViewInUse:function(){this._refCount++},stopViewInUse:function(){this._refCount--,0===this._refCount&&this.send(n.proxyReadyForRelease)},openAsync:function(e,i){var n=this,t=e||Windows.UI.ViewManagement.ViewSizePreference["default"],s=i||Windows.UI.ViewManagement.ViewSizePreference["default"];return n.startViewInUse(),new WinJS.Promise(function(e,i){Windows.UI.ViewManagement.ApplicationViewSwitcher.tryShowAsStandaloneAsync(n.viewId,s,Windows.UI.ViewManagement.ApplicationView.getForCurrentView().id,t).done(function(i){n.stopViewInUse(),e({view:n,pointer:i})},i)})},close:function(){var i=this;i.startViewInUse();var n=function(){i.stopViewInUse()};return e.ApplicationViewSwitcher.switchAsync(e.ApplicationView.getForCurrentView().id,i.viewId,e.ApplicationViewSwitchingOptions.consolidateViews).then(n,n)}}),WinJS.Utilities.eventMixin,WinJS.Binding.observableMixin),ViewLifetimeControl:WinJS.Class.mix(WinJS.Class.define(function(){this.opener=MSApp.getViewOpener(),this._handleMessageWrapper=this._handleMessage.bind(this),this._onConsolidatedWrapper=this._onConsolidated.bind(this),this._onVisibilityChangeWrapper=this._onVisibilityChange.bind(this),this._finalizeReleaseWrapper=this._finalizeRelease.bind(this),this.viewId=e.ApplicationView.getForCurrentView().id},{_refCount:0,_proxyReleased:!1,_consolidated:!0,send:function(e,i){if(!e)throw"Must specify a type of message to send to the proxy";i=i||{},i.type=e,i.viewId=this.viewId,this.opener.postMessage(i,WinJSContrib.WinRT.MultipleViews.thisDomain)},_handleMessage:function(e){if(e.origin===WinJSContrib.WinRT.MultipleViews.thisDomain&&e.data.type){var i=e.data;switch(i.type){case n.proxyReleased:this._proxyReleased=!0,setImmediate(this._finalizeReleaseWrapper);break;case n.proxyReadyForRelease:0===this._refCount&&this.send(n.queryProxyReadyForRelease);break;case n.initialize:this.dispatchEvent("initialize",e.data.initData);break;default:this.dispatchEvent(i.type,i)}}},_onConsolidated:function(){this._setConsolidated(!0)},_onVisibilityChange:function(){document.hidden||this._setConsolidated(!1)},_setConsolidated:function(e){this._consolidated!==e&&(this._consolidated=e,e?this.stopViewInUse():this.startViewInUse())},_finalizeRelease:function(i){(0===this._refCount||i)&&(window.removeEventListener("message",this._handleMessageWrapper,!1),e.ApplicationView.getForCurrentView().removeEventListener("consolidated",this._onConsolidatedWrapper,!1),document.removeEventListener("visibilitychange",this._onVisibilityChangeWrapper,!1),this.dispatchEvent("released"),window.close())},initialize:function(){window.addEventListener("message",this._handleMessageWrapper,!1),e.ApplicationView.getForCurrentView().addEventListener("consolidated",this._onConsolidatedWrapper,!1),document.addEventListener("visibilitychange",this._onVisibilityChangeWrapper,!1)},startViewInUse:function(){this._refCount++},close:function(){this.stopViewInUse()},stopViewInUse:function(){this._refCount--,0===this._refCount&&(this._proxyReleased?setImmediate(this._finalizeReleaseWrapper):this.send(n.queryProxyReadyForRelease))}}),WinJS.Utilities.eventMixin)})}();