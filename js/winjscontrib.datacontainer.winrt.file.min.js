/* 
 * WinJS Contrib v2.0.1.0
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

!function(){"use strict";function n(n){return encodeURIComponent(n)+".json"}function t(t,r,e){return t.getItemAsync(n(r)).then(function(n){return n},function(){}).then(function(n){return n?n.deleteAsync().then(function(){e&&e.debug("item deleted "+n.path)},function(){e&&e.error("cannot delete item "+n.path)}):WinJS.Promise.wrap([])})}function r(n,t){return Windows.Storage.FileIO.readBufferAsync(n).then(function(n){if(!t)return n;if(n.length){var r=new Windows.Security.Cryptography.DataProtection.DataProtectionProvider;return r.unprotectAsync(n)}return null}).then(function(n){var t=null;if(n){var r=Windows.Security.Cryptography.CryptographicBuffer.convertBinaryToString(Windows.Security.Cryptography.BinaryStringEncoding.utf8,n);if(r)try{t=JSON.parse(r)}catch(e){}}return t})}function e(t,i,o,a,s,u){return new WinJS.Promise(function(c,f){s=s||0,a=a||Windows.Storage.CreationCollisionOption.openIfExists;var p=n(i);t.getFileAsync(p).then(function(n){return r(n,o)}).then(function(n){c(n)},function(r){return-2147024894==r.number?void c():(u&&u.warn("error reading "+t.path+"\\"+n(i)),void(2>s?setImmediate(function(){u&&u.debug("retry reading "+t.path+"\\"+n(i)),e(t,i,o,a,s+1,u).then(c,f)}):f({message:"fatal error reading "+t.path+"\\"+n(i),exception:r})))})})}function i(t,r,e,o,a,s,u){return new WinJS.Promise(function(c,f){function p(p){u&&u.warn("error writing "+t.path+"\\"+n(r)),2>s?setImmediate(function(){u&&u.debug("retry writing "+t.path+"\\"+n(r)),i(t,r,e,o,a,s+1,u).then(c,f)}):f({message:"fatal error writing "+t.path+"\\"+n(r)+"\r\n",exception:p})}s=s||0,a=a||Windows.Storage.CreationCollisionOption.replaceExisting;var d=Windows.Security.Cryptography.CryptographicBuffer.convertStringToBinary(JSON.stringify(e),Windows.Security.Cryptography.BinaryStringEncoding.utf8),l=new Windows.Security.Cryptography.DataProtection.DataProtectionProvider("Local=user"),g=t.createFileAsync(n(r),a),h=o?l.protectAsync(d):WinJS.Promise.wrap(d);WinJS.Promise.join([g,h]).then(function(n){var t=n[0],r=n[1];Windows.Storage.FileIO.writeBufferAsync(t,r).then(function(){u&&u.debug("file written "+t.path),c(t)},p)},p)})}WinJS.Namespace.define("WinJSContrib.DataContainer",{WinRTFilesContainer:WinJS.Class.define(function(n,t,r){var e=this;if(e.key=n,e.options=t||{},e.parent=r,e.folderPromise,!window.Windows)throw"WinRT is required !";n?r&&(e.folderPromise=r.folderPromise.then(function(t){return e.options.logger&&e.options.logger.debug("open folder "+n),t.createFolderAsync(n,Windows.Storage.CreationCollisionOption.openIfExists)}).then(function(n){return e.folder=n,n})):(e.folder=Windows.Storage.ApplicationData.current.localFolder,e.folderPromise=WinJS.Promise.wrap(e.folder))},{read:function(n){var t=this;return t.folderPromise.then(function(r){return e(r,n,t.options.encrypted,Windows.Storage.CreationCollisionOption.openIfExists,0,t.options.logger)})},save:function(n,t){var r=this;return r.folderPromise.then(function(e){return i(e,n,t,r.options.encrypted,Windows.Storage.CreationCollisionOption.replaceExisting,0,r.options.logger)})},remove:function(n){var r=this;return r.folderPromise.then(function(e){return t(e,n,r.options.logger)})},list:function(){var n=this;return n.folderPromise.then(function(n){return n.getFilesAsync()})},child:function(n){if(this[n])return this[n];var t=new WinJSContrib.DataContainer.WinRTFilesContainer(n,this.options,this);return this[n]=t,t}})})}();