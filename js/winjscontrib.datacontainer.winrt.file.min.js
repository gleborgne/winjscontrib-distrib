/* 
 * WinJS Contrib v2.1.0.0
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

!function(n){"use strict";function e(n){return encodeURIComponent(n)+".json"}function t(n,t,r){return n.getItemAsync(e(t)).then(function(n){return n},function(){}).then(function(n){return n?n.deleteAsync().then(function(){r&&r.debug("item deleted "+n.path)},function(){r&&r.error("cannot delete item "+n.path)}):WinJS.Promise.wrap([])})}function r(n,e){return Windows.Storage.FileIO.readBufferAsync(n).then(function(n){if(!e)return n;if(n.length){var t=new Windows.Security.Cryptography.DataProtection.DataProtectionProvider;return t.unprotectAsync(n)}return null}).then(function(n){var e=null;if(n){var t=Windows.Security.Cryptography.CryptographicBuffer.convertBinaryToString(Windows.Security.Cryptography.BinaryStringEncoding.utf8,n);if(t)try{e=JSON.parse(t)}catch(r){}}return e})}function i(n,t,o,a,c,s){return new WinJS.Promise(function(u,h){c=c||0,a=a||Windows.Storage.CreationCollisionOption.openIfExists;var f=e(t);n.getFileAsync(f).then(function(n){return r(n,o)}).then(function(r){s&&s.debug("read "+n.path+"\\"+e(t)),u(r)},function(r){return-2147024894==r.number?(s&&s.debug("read empty "+n.path+"\\"+e(t)),void u()):(s&&s.warn("error reading "+n.path+"\\"+e(t)),void(2>c?setImmediate(function(){s&&s.debug("retry reading "+n.path+"\\"+e(t)),i(n,t,o,a,c+1,s).then(u,h)}):h({message:"fatal error reading "+n.path+"\\"+e(t),exception:r})))})})}function o(n,t,r,i,a,c,s){return new WinJS.Promise(function(u,h){function f(f){s&&s.warn("error writing "+n.path+"\\"+e(t)),2>c?setImmediate(function(){s&&s.debug("retry writing "+n.path+"\\"+e(t)),o(n,t,r,i,a,c+1,s).then(u,h)}):h({message:"fatal error writing "+n.path+"\\"+e(t)+"\r\n",exception:f})}c=c||0,a=a||Windows.Storage.CreationCollisionOption.replaceExisting;var d=Windows.Security.Cryptography.CryptographicBuffer.convertStringToBinary(JSON.stringify(r),Windows.Security.Cryptography.BinaryStringEncoding.utf8);if(i)var l=new Windows.Security.Cryptography.DataProtection.DataProtectionProvider("Local=user");var p=n.createFileAsync(e(t),a),g=i?l.protectAsync(d):WinJS.Promise.wrap(d);WinJS.Promise.join([p,g]).then(function(n){var e=n[0],t=n[1];Windows.Storage.FileIO.writeBufferAsync(e,t).then(function(){s&&s.debug("file written "+e.path),u(e)},f)},f)})}WinJS.Namespace.define("WinJSContrib.DataContainer",{WinRTFilesContainer:WinJS.Class.define(function(e,t,r){var i=this;if(i.key=e,i.options=t||{},i.parent=r,i.folderPromise,i.useDataCache=t.useDataCache||!1,i.dataCache={},i.childs={},!n.Windows)throw"WinRT is required !";e?r&&(i.folderPromise=r.folderPromise.then(function(n){return i.options.logger&&i.options.logger.debug("open folder "+e),n.createFolderAsync(e,Windows.Storage.CreationCollisionOption.openIfExists)}).then(function(n){return i.folder=n,n})):(i.folder=Windows.Storage.ApplicationData.current.localFolder,i.folderPromise=WinJS.Promise.wrap(i.folder))},{read:function(n){var e=this;if(e.useDataCache){var t=e.dataCache[n];if(t){var r=JSON.parse(JSON.stringify(t));return WinJS.Promise.wrap(r)}}return e.folderPromise.then(function(t){return i(t,n,e.options.encrypted,Windows.Storage.CreationCollisionOption.openIfExists,0,e.options.logger).then(function(t){return e.useDataCache&&(e.dataCache[n]=t),t})})},save:function(n,e){var t=this;return t.useDataCache&&(t.dataCache[n]=e),t.folderPromise.then(function(r){return o(r,n,e,t.options.encrypted,Windows.Storage.CreationCollisionOption.replaceExisting,0,t.options.logger)})},remove:function(n){var e=this;return e.folderPromise.then(function(r){return t(r,n,e.options.logger)})},list:function(){var n=this;return n.folderPromise.then(function(n){return n.getFilesAsync()})},child:function(n){if(this.childs[n])return this.childs[n];var e=new WinJSContrib.DataContainer.WinRTFilesContainer(n,this.options,this);return this.childs[n]=e,e},clearAllCache:function(){var n=this;n.clearCache(),n.clearDataCache()},clearCache:function(){var n=this;n.childs={};for(var e in n.childs)n.childs.hasOwnProperty(e)&&n.childs[e].clearCache()},clearDataCache:function(){var n=this;n.dataCache={};for(var e in n.childs)n.childs.hasOwnProperty(e)&&n.childs[e].clearDataCache()}})})}(this);