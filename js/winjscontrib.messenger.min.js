var WinJSContrib=WinJSContrib||{};!function(){function Messenger(e,n){var r=this;r.isWorker=void 0===e.document,r._pendings={},r._receiver=e,r._sender=n||e,r._bindedProcessEvent=r._processEvent.bind(r),r._receiver&&r._receiver.addEventListener("message",r._bindedProcessEvent)}WinJSContrib.Messenger=WinJS.Class.mix(Messenger,WinJS.Utilities.eventMixin),WinJSContrib.Messenger.SmartWorkerPath="/scripts/winjscontrib/winjscontrib.messenger.worker.js",WinJSContrib.Messenger.SmartWorker=function(e){if(window.Worker){var n=new window.Worker(e||WinJSContrib.Messenger.SmartWorkerPath);return new WinJSContrib.Messenger(n,n)}return new WinJSContrib.Messenger(null,null)},WinJSContrib.Messenger.prototype._send=function(e){this.isWorker?this._sender.postMessage(JSON.stringify(e)):this._sender.postMessage(JSON.stringify(e),"*")},WinJSContrib.Messenger.prototype.importScripts=function(e){return this._receiver?this.start("_doImportScripts",e):WinJS.Promise.wrap()},WinJSContrib.Messenger.prototype._doImportScripts=function(e){return new WinJS.Promise(function(n){if("string"==typeof e)importScripts(e);else if(e.length)for(var r=0;r<e.length;r++)importScripts(e[r]);n()})},WinJSContrib.Messenger.prototype.execute=function(e){var n=this,r=[];if(arguments.length>1)for(var i=1;i<arguments.length;i++)r.push(arguments[i]);if(n._receiver){var t="var messengerFunction="+e;return this.start("_runFunction",{f:t,args:r})}return WinJS.Promise.timeout(0).then(function(){return e.apply(null,r)})},WinJSContrib.Messenger.prototype._runFunction=function(functionArgs){var messenger=this;return new WinJS.Promise(function(c,e){try{eval(functionArgs.f);var res=messengerFunction.apply(null,functionArgs.args);c(res)}catch(exception){e(exception)}})},WinJSContrib.Messenger.prototype.start=function(e,n){var r=this;if(!r._receiver)return WinJS.Promise.wrapError("worker not supported");var i={id:WinJSContrib.Utils.guid(),complete:null,error:null,progress:null,promise:null},t={name:e,id:i.id,type:"run",data:n,sender:"WinJSContrib.WinJSContrib.Messenger"};i.promise=new WinJS.Promise(function(e,n,r){i.complete=e,i.error=n,i.progress=r}),r._pendings[i.id]=i;var s=function(){delete r._pendings[i.id]};return i.promise.done(s,s),r._send(t),i.promise},WinJSContrib.Messenger.prototype._processEvent=function(e){var n=this,r="string"==typeof e.data?JSON.parse(e.data):e.data,i=r.name,t=r.data;if(r.id){var s=n._pendings[r.id];if(s&&s[r.type])return void s[r.type](t);if(i&&n[i]){try{WinJS.Promise.as(n[i](t)).then(function(e){n._send({name:i,id:r.id,type:"complete",sender:"WinJSContrib.WinJSContrib.Messenger",data:e})},function(e){n._send({name:i,id:r.id,type:"error",sender:"WinJSContrib.WinJSContrib.Messenger",data:e})},function(e){n._send({name:i,id:r.id,type:"progress",sender:"WinJSContrib.WinJSContrib.Messenger",data:e})})}catch(o){n._send({name:i,id:r.id,type:"error",sender:"WinJSContrib.WinJSContrib.Messenger",data:{description:o.description,message:o.message,stack:o.stack}})}return}}else{if(i&&n[i])return void n[i](t);n.dispatchEvent(i,t)}},WinJSContrib.Messenger.prototype.dispose=function(){var e=this;e._receiver&&(e._receiver.terminate&&e._receiver.terminate(),e._receiver.removeEventListener("message",e._bindedProcessEvent))}}();