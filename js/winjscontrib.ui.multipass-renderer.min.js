var WinJSContrib=WinJSContrib||{};WinJSContrib.UI=WinJSContrib.UI||{},function(){"use strict";WinJSContrib.UI.MultiPassRenderer=WinJS.Class.define(function(e,t){t=t||{},this.items=[],this.element=e,this._scrollProcessor=null,this._tolerance=1,this._scrollContainer=t.scrollContainer||null,this._multipass=t.multipass||!1,this._orientation=t.orientation||"",this.itemClassName=t.itemClass||t.className||t.itemClassName,this.itemTemplate=WinJSContrib.Utils.getTemplate(t.template||t.itemTemplate),this.itemInvoked=t.invoked||t.itemInvoked,this.onitemContent=t.onitemContent,this._onScrollBinded=this._onScroll.bind(this),e&&(e.className=e.className+" mcn-items-ctrl mcn-layout-ctrl win-disposable")},{multipass:{get:function(){return this._multipass},set:function(e){this._multipass=e,this.refreshScrollEvents()}},tolerance:{get:function(){return this._tolerance},set:function(e){this._tolerance=e}},orientation:{get:function(){return this._orientation},set:function(e){this._orientation=e,this.refreshScrollEvents()}},scrollContainer:{get:function(){return this._scrollContainer},set:function(e){this._unregisterScrollEvents(),this._scrollContainer=e,this._registerScrollEvents(),this.checkRendering()}},_onScroll:function(){var e=this;e.scrollContainer&&e._scrollProcessor&&(e._scrollRequest&&cancelAnimationFrame(e._scrollRequest),e._scrollRequest=requestAnimationFrame(function(){e.checkRendering()}))},_unregisterScrollEvents:function(){this._scrollProcessor=null,this.clearOffsets(),this.scrollContainer&&this.scrollContainer.removeEventListener("scroll",this._onScrollBinded)},_registerScrollEvents:function(){var e=this;e.scrollContainer&&(this.scrollContainer.addEventListener("scroll",this._onScrollBinded),"vertical"==e.orientation?"section"==e.multipass?e._scrollProcessor=function(){e._checkSection(e._vIsInView)}:"item"==e.multipass&&(e._scrollProcessor=function(){e._checkItem(e._vIsInView)}):"section"==e.multipass?e._scrollProcessor=function(){e._checkSection(e._hIsInView)}:"item"==e.multipass&&(e._scrollProcessor=function(){e._checkItem(e._hIsInView)}))},refreshScrollEvents:function(){this._unregisterScrollEvents(),this._registerScrollEvents()},_vIsInView:function(e,t,n){var i=t.clientHeight*n;return e.y>t.scrollTop-i&&e.y<t.scrollTop+t.clientHeight+i?!0:e.y+e.height>t.scrollTop-i&&e.y+e.height<t.scrollTop+t.clientHeight+i?!0:!1},_hIsInView:function(e,t,n){var i=t.clientWidth*(n||0);return e.x>t.scrollLeft-i&&e.x<t.scrollLeft+t.clientWidth+i?!0:e.x+e.width>t.scrollLeft-i&&e.x+e.width<t.scrollLeft+t.clientWidth+i?!0:!1},clearOffsets:function(){var e=this;e.rect=null,e.items.forEach(function(e){e.rect=null})},pageLayout:function(){var e=this;e.clearOffsets()},updateLayout:function(){var e=this;e.clearOffsets()},_checkSection:function(e,t){var n=this;t=t||0,n.rect||(n.rect=WinJSContrib.UI.offsetFrom(n.element,n.scrollContainer)),e(n.rect,n.scrollContainer,t)&&(n.renderItemsContent(),n.onrendersection&&n.onrendersection()),0==t&&n.tolerance>0&&setImmediate(function(){n._checkSection(e,n.tolerance)})},_checkItem:function(e,t){var n=this;t=t||0;var i=!0;n.items.forEach(function(r){r.rect||(r.rect=WinJSContrib.UI.offsetFrom(r.element,n.scrollContainer)),i&=r.rendered,!r.rendered&&e(r.rect,n.scrollContainer,t)&&r.render()}),n.allRendered=i,0==t&&n.tolerance>0&&setImmediate(function(){n._checkItem(e,n.tolerance)})},prepareItems:function(e,t){var n=this;e=e||[],t=t||{};var i=e.length,r=t.itemInvoked||n.itemInvoked;"string"==typeof r&&(r=WinJSContrib.Utils.resolveMethod(n.element,r));for(var s=WinJSContrib.Utils.getTemplate(t.template)||n.itemTemplate,o=t.itemClassName||n.itemClassName,l=t.onitemContent||n.onitemContent,c=n.element,a=n.items,m=0;i>m;m++){var h=e[m],u=new WinJSContrib.UI.MultiPassItem(n,null,{data:h,template:s,className:o,itemInvoked:r,onitemContent:l});a.push(u),c.appendChild(u.element)}(t.renderItems||!this.multipass)&&n.renderItemsContent()},checkRendering:function(){var e=this;e._scrollProcessor&&e._scrollProcessor()},renderItemsContent:function(){var e=this;e.items.forEach(function(e){e.rendered||e.render()}),e.allRendered=!0},dispose:function(){var e=this;e._unregisterScrollEvents(),WinJS.Utilities.disposeSubTree(e.element)}}),WinJSContrib.UI.MultiPassItem=WinJS.Class.define(function(e,t,n){n=n||{};var i=this;i.renderer=e,i.element=t||document.createElement("DIV"),i.element.className=i.element.className+" "+n.className+" mcn-multipass-item",i.element.winControl=i,i.itemInvoked=n.itemInvoked,i.itemDataPromise=WinJS.Promise.as(n.data),i.itemTemplate=n.template,i.rendered=!1},{render:function(){var e=this;return e.itemTemplate&&!e.rendered?(e.rendered=!0,e._renderContent()):WinJS.Promise.wrap(e.contentElement)},_renderContent:function(){var e=this;return e.itemTemplate?e.itemDataPromise.then(function(t){return e.itemData=t,e.itemTemplate.render(t).then(function(t){return e.element.appendChild(t),e.itemInvoked&&("string"==typeof e.itemInvoked&&(e.itemInvoked=WinJSContrib.Utils.resolveMethod(e.element,e.itemInvoked)),e.itemInvoked&&$(e.element).tap(function(){e.itemInvoked(e)})),e.onitemContent?e.onitemContent(e.itemData,t):e.renderer.onitemContent&&e.renderer.onitemContent(e.itemData,t),setImmediate(function(){e.element.classList.add("loaded")}),e.rendered=!0,e.contentElement=t,t})}):WinJS.Promise.wrap()}})}();